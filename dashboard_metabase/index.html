<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Revit MCP + Metabase</title>
    <link rel="stylesheet" href="./iofbim-tokens.css" />
    <style>
      :root {
        --bg: rgb(var(--color-customBg, 228 227 225));
        --panel: rgb(var(--color-textLight, 241 235 231));
        --text: rgb(var(--color-textDark, 63 59 54));
        --muted: rgb(var(--color-textMid, 106 97 92));
        --accent: rgb(var(--color-textAccent, 70 145 98));
        --border: rgba(var(--color-textDark, 63 59 54), 0.15);
        --hover: rgba(var(--color-textDark, 63 59 54), 0.05);
      }
      * { box-sizing: border-box; }
      body { margin:0; background:var(--bg); color:var(--text); font:12px/1.35 system-ui,Segoe UI,Roboto,Arial; }
      header { padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
      h1 { font-size:16px; margin:0; letter-spacing:.3px; }
      .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      label.badge { font-size:10px; color:var(--muted); }
      input, select { background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 8px; }
      .layout { display:grid; grid-template-columns: 1fr; gap:14px; padding:14px; }
      .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; }
      .badge { font-size:10px; color:var(--muted); }
      button { background:var(--hover); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer; }
      #mbFrame { width:100%; height:74vh; border:0; background:white; border-radius:8px; }
      footer { color:var(--muted); padding:12px 16px; font-size:12px; border-top:1px solid var(--border); }
      .row { display:flex; gap:8px; align-items:center; }
      .col { display:flex; flex-direction:column; gap:6px; }
    </style>
  </head>
  <body>
    <header>
      <h1>Revit MCP + Metabase</h1>
      <div class="controls">
        <div class="row">
          <label class="badge" for="endpoint">MCP</label>
          <input id="endpoint" type="text" value="http://localhost:5005/mcp/" style="min-width:260px" />
        </div>
        <div class="row">
          <label class="badge" for="model">Model</label>
          <select id="model" style="min-width:260px"></select>
        </div>
        <div class="row" id="n8nInputs">
          <label class="badge" for="n8nWebhook">n8n Webhook</label>
          <input id="n8nWebhook" type="text" value="http://localhost:5678/webhook/1b5eef7c-a810-43f0-ac57-7d85fc820719/chat" style="min-width:360px" />
        </div>
        <button id="refresh">Refresh Models</button>
      </div>
    </header>

    <main class="layout">
      <section class="card">
        <h2 class="badge" style="margin:0 0 8px">Metabase Embed</h2>
        <div class="col" style="gap:10px">
          <div class="row" style="flex-wrap:wrap">
            <div class="row" style="flex:1 1 320px; min-width:320px">
              <label class="badge" for="mbMode">Mode</label>
              <select id="mbMode">
                <option value="direct">Direct URL (public/signed)</option>
                <option value="template">Template URL (placeholders)</option>
                <option value="backend">Backend Endpoint (returns URL)</option>
              </select>
            </div>
            <div class="row" id="mbDirectRow" style="flex:3 1 520px; min-width:480px">
              <label class="badge" for="mbDirect">Direct URL</label>
              <input id="mbDirect" type="text" placeholder="Paste Metabase Public Link or already-signed URL" style="flex:1" />
            </div>
            <div class="row" id="mbTplRow" style="flex:3 1 520px; min-width:480px; display:none">
              <label class="badge" for="mbTpl">Template URL</label>
              <input id="mbTpl" type="text" placeholder=".../dashboard/abcd?doc_id={doc_id}&model={model_name}#bordered=false&titled=false" style="flex:1" />
            </div>
            <div class="row" id="mbBackendRow" style="flex:3 1 520px; min-width:480px; display:none">
              <label class="badge" for="mbBackend">Backend Endpoint</label>
              <input id="mbBackend" type="text" placeholder="http://localhost:5000/embed/metabase?doc_id={doc_id}&model_name={model_name}" style="flex:1" />
            </div>
            <button id="loadMb" style="background:var(--accent); color:white">Load Metabase</button>
          </div>
          <div class="badge" id="hint"></div>
          <iframe id="mbFrame" title="Metabase"></iframe>
        </div>
      </section>
    </main>

    <!-- Slide-up Drawer Chat (n8n) -->
    <div id="miniDrawer" aria-label="Chat drawer" style="position:fixed; left:0; right:0; bottom:0; z-index:20; pointer-events:none;">
      <div id="miniDrawerBar" style="margin:auto; width:min(980px, 96%); pointer-events:auto;">
        <div id="miniDrawerHandle" style="display:flex; align-items:center; gap:8px; justify-content:space-between; background:var(--text); color:var(--panel); border:1px solid var(--text); border-bottom:none; border-radius:12px 12px 0 0; padding:6px 10px; cursor:pointer;">
          <div class="badge" style="color:var(--panel)">Chat</div>
          <div id="miniDrawerHint" class="badge" style="opacity:.9; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:70%; color:var(--panel)"></div>
          <div class="badge" id="miniDrawerChevron" style="color:var(--panel)">^</div>
        </div>
        <div id="miniDrawerBody" style="display:none; background:var(--text); color:var(--panel); border:1px solid var(--text); border-top:none; border-radius:0 0 12px 12px; padding:8px;">
          <div id="miniChatAI" class="badge" style="font-size:12px; line-height:1.35; max-height:5.6em; overflow:auto; white-space:pre-wrap; border:1px solid var(--border); border-radius:8px; padding:6px; background:#2b2b2b; color:var(--panel);"></div>
          <div style="display:flex; gap:8px; align-items:flex-start; margin-top:8px;">
            <textarea id="miniChatInput" rows="2" placeholder="Type your message..." style="flex:1; resize:vertical; max-height:3.2em; background:#2b2b2b; color:var(--panel); border:1px solid var(--border); border-radius:8px; padding:6px; font-size:12px;"></textarea>
            <button id="miniChatSend" style="background:var(--accent); color:white; border:none; border-radius:8px; padding:8px 10px; cursor:pointer;">Send</button>
            <button id="miniChatStop" style="background:#444; color:var(--panel); border:1px solid var(--border); border-radius:8px; padding:8px 10px; cursor:pointer;">Stop</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      Metabase embed prototype. Use signed embedding via a backend for secure filters.
    </footer>

    <script src="./metabase.js"></script>
  </body>
  </html>
